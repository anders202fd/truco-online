"use strict";(()=>{var r={};r.id=866,r.ids=[866],r.modules={399:r=>{r.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:r=>{r.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3305:(r,e,t)=>{t.r(e),t.d(e,{originalPathname:()=>O,patchFetch:()=>m,requestAsyncStorage:()=>l,routeModule:()=>E,serverHooks:()=>R,staticGenerationAsyncStorage:()=>w});var o={};t.r(o),t.d(o,{GET:()=>p,POST:()=>d});var s=t(9303),a=t(8716),n=t(670),i=t(7070),c=t(7046),u=t(8990);async function d(r){try{await (0,c.uD)();let{userId:e,amount:t,paymentId:o}=await r.json();if(!e||!t||t<=0)return i.NextResponse.json({success:!1,error:"Dados inv\xe1lidos"},{status:400});let s=await (0,u.GA)(e);if(!s)return i.NextResponse.json({success:!1,error:"Usu\xe1rio n\xe3o encontrado"},{status:404});let a=await (0,u._X)(e,"deposit",t,"Dep\xf3sito via Mercado Pago",o),n=s.balance+t;return await (0,u.yi)(e,n),i.NextResponse.json({success:!0,data:{transaction:a,newBalance:n}})}catch(r){return console.error("Erro ao processar dep\xf3sito:",r),i.NextResponse.json({success:!1,error:"Erro interno do servidor"},{status:500})}}async function p(r){try{await (0,c.uD)();let{searchParams:e}=new URL(r.url),t=e.get("userId");if(!t)return i.NextResponse.json({success:!1,error:"ID do usu\xe1rio \xe9 obrigat\xf3rio"},{status:400});let o=await getUserTransactions(parseInt(t));return i.NextResponse.json({success:!0,data:o})}catch(r){return console.error("Erro ao buscar transa\xe7\xf5es:",r),i.NextResponse.json({success:!1,error:"Erro interno do servidor"},{status:500})}}let E=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/transactions/route",pathname:"/api/transactions",filename:"route",bundlePath:"app/api/transactions/route"},resolvedPagePath:"/workspaces/truco-online/src/app/api/transactions/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:l,staticGenerationAsyncStorage:w,serverHooks:R}=E,O="/api/transactions/route";function m(){return(0,n.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:w})}},8990:(r,e,t)=>{t.d(e,{A4:()=>u,CX:()=>a,GA:()=>n,Ls:()=>p,_X:()=>l,dB:()=>c,k1:()=>E,r4:()=>s,ve:()=>w,wW:()=>d,yi:()=>i});var o=t(7046);let s=async(r,e,t)=>(await (0,o.IO)("INSERT INTO users (email, username, password_hash) VALUES ($1, $2, $3) RETURNING *",[r,e,t])).rows[0],a=async r=>(await (0,o.IO)("SELECT * FROM users WHERE email = $1",[r])).rows[0],n=async r=>(await (0,o.IO)("SELECT * FROM users WHERE id = $1",[r])).rows[0],i=async(r,e)=>(await (0,o.IO)("UPDATE users SET balance = $1 WHERE id = $2 RETURNING *",[e,r])).rows[0],c=async(r,e,t,s=!1)=>{let a=s?Math.random().toString(36).substring(2,8).toUpperCase():null;return(await (0,o.IO)("INSERT INTO rooms (name, creator_id, bet_amount, is_private, room_code) VALUES ($1, $2, $3, $4, $5) RETURNING *",[r,e,t,s,a])).rows[0]},u=async(r=20)=>(await (0,o.IO)("SELECT r.*, u.username as creator_username FROM rooms r JOIN users u ON r.creator_id = u.id WHERE r.status = $1 ORDER BY r.created_at DESC LIMIT $2",["waiting",r])).rows,d=async r=>(await (0,o.IO)("SELECT * FROM rooms WHERE id = $1",[r])).rows[0],p=async(r,e)=>{let t=await d(r);if(!t||t.current_players>=t.max_players)throw Error("Sala n\xe3o encontrada ou lotada");return await (0,o.IO)("INSERT INTO room_participants (room_id, user_id, position) VALUES ($1, $2, $3)",[r,e,t.current_players+1]),await (0,o.IO)("UPDATE rooms SET current_players = current_players + 1 WHERE id = $1",[r]),!0},E=async r=>(await (0,o.IO)("SELECT rp.*, u.username FROM room_participants rp JOIN users u ON rp.user_id = u.id WHERE rp.room_id = $1 ORDER BY rp.position",[r])).rows,l=async(r,e,t,s,a)=>(await (0,o.IO)("INSERT INTO transactions (user_id, type, amount, description, mercadopago_payment_id) VALUES ($1, $2, $3, $4, $5) RETURNING *",[r,e,t,s||null,a||null])).rows[0],w=async(r,e=50)=>(await (0,o.IO)("SELECT * FROM transactions WHERE user_id = $1 ORDER BY created_at DESC LIMIT $2",[r,e])).rows},7046:(r,e,t)=>{t.d(e,{IO:()=>n,uD:()=>a}),function(){var r=Error("Cannot find module 'pg'");throw r.code="MODULE_NOT_FOUND",r}();let o=process.env.DATABASE_URL;if(!o)throw Error("❌ DATABASE_URL n\xe3o foi definido no arquivo .env.local");let s=Object(function(){var r=Error("Cannot find module 'pg'");throw r.code="MODULE_NOT_FOUND",r}())({connectionString:o,ssl:{rejectUnauthorized:!1},max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3}),a=async()=>{try{let r=await s.connect();return console.log("✅ PostgreSQL conectado com sucesso!"),r.release(),s}catch(r){throw console.error("❌ Erro ao conectar ao PostgreSQL:",r),r}},n=async(r,e)=>{try{return await s.query(r,e)}catch(r){throw console.error("❌ Erro ao executar query:",r),r}}}};var e=require("../../../webpack-runtime.js");e.C(r);var t=r=>e(e.s=r),o=e.X(0,[948,972],()=>t(3305));module.exports=o})();