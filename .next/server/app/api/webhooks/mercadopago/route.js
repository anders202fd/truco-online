"use strict";(()=>{var e={};e.id=586,e.ids=[586],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},1359:(e,r,o)=>{o.r(r),o.d(r,{originalPathname:()=>y,patchFetch:()=>h,requestAsyncStorage:()=>O,routeModule:()=>w,serverHooks:()=>_,staticGenerationAsyncStorage:()=>R});var a={};o.r(a),o.d(a,{POST:()=>m});var t=o(9303),s=o(8716),n=o(670),i=o(7070),c=o(6994);let u=new c.f7({accessToken:process.env.MERCADOPAGO_ACCESS_TOKEN||"",options:{timeout:5e3,idempotencyKey:"abc"}}),p=new c.F6(u);async function d(e){try{if("payment"===e.type){let r=await p.get({id:e.data.id});return{id:r.id,status:r.status,amount:r.transaction_amount,external_reference:r.external_reference,payer_email:r.payer?.email}}return null}catch(e){throw console.error("Erro ao processar webhook:",e),e}}new c.Jk(u);var l=o(8990),E=o(7046);async function m(e){try{await (0,E.uD)();let r=await e.json();console.log("Webhook recebido:",r);let o=await d(r);if(!o)return i.NextResponse.json({success:!0,message:"Webhook ignorado"});if("approved"===o.status){let e=o.external_reference,r=e?.match(/user_(\d+)_/);if(r){let e=parseInt(r[1]),a=await (0,l.GA)(e);if(a){let r=a.balance+(o.amount||0);await (0,l.yi)(e,r),await (0,l._X)(e,"deposit",o.amount||0,`Dep\xf3sito via Mercado Pago - ID: ${o.id}`,o.id?.toString()),console.log(`Saldo atualizado para usu\xe1rio ${e}: R$ ${r}`)}}}return i.NextResponse.json({success:!0})}catch(e){return console.error("Erro ao processar webhook:",e),i.NextResponse.json({success:!1,error:"Erro interno do servidor"},{status:500})}}let w=new t.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/webhooks/mercadopago/route",pathname:"/api/webhooks/mercadopago",filename:"route",bundlePath:"app/api/webhooks/mercadopago/route"},resolvedPagePath:"/workspaces/truco-online/src/app/api/webhooks/mercadopago/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:O,staticGenerationAsyncStorage:R,serverHooks:_}=w,y="/api/webhooks/mercadopago/route";function h(){return(0,n.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:R})}},8990:(e,r,o)=>{o.d(r,{A4:()=>u,CX:()=>s,GA:()=>n,Ls:()=>d,_X:()=>E,dB:()=>c,k1:()=>l,r4:()=>t,ve:()=>m,wW:()=>p,yi:()=>i});var a=o(7046);let t=async(e,r,o)=>(await (0,a.IO)("INSERT INTO users (email, username, password_hash) VALUES ($1, $2, $3) RETURNING *",[e,r,o])).rows[0],s=async e=>(await (0,a.IO)("SELECT * FROM users WHERE email = $1",[e])).rows[0],n=async e=>(await (0,a.IO)("SELECT * FROM users WHERE id = $1",[e])).rows[0],i=async(e,r)=>(await (0,a.IO)("UPDATE users SET balance = $1 WHERE id = $2 RETURNING *",[r,e])).rows[0],c=async(e,r,o,t=!1)=>{let s=t?Math.random().toString(36).substring(2,8).toUpperCase():null;return(await (0,a.IO)("INSERT INTO rooms (name, creator_id, bet_amount, is_private, room_code) VALUES ($1, $2, $3, $4, $5) RETURNING *",[e,r,o,t,s])).rows[0]},u=async(e=20)=>(await (0,a.IO)("SELECT r.*, u.username as creator_username FROM rooms r JOIN users u ON r.creator_id = u.id WHERE r.status = $1 ORDER BY r.created_at DESC LIMIT $2",["waiting",e])).rows,p=async e=>(await (0,a.IO)("SELECT * FROM rooms WHERE id = $1",[e])).rows[0],d=async(e,r)=>{let o=await p(e);if(!o||o.current_players>=o.max_players)throw Error("Sala n\xe3o encontrada ou lotada");return await (0,a.IO)("INSERT INTO room_participants (room_id, user_id, position) VALUES ($1, $2, $3)",[e,r,o.current_players+1]),await (0,a.IO)("UPDATE rooms SET current_players = current_players + 1 WHERE id = $1",[e]),!0},l=async e=>(await (0,a.IO)("SELECT rp.*, u.username FROM room_participants rp JOIN users u ON rp.user_id = u.id WHERE rp.room_id = $1 ORDER BY rp.position",[e])).rows,E=async(e,r,o,t,s)=>(await (0,a.IO)("INSERT INTO transactions (user_id, type, amount, description, mercadopago_payment_id) VALUES ($1, $2, $3, $4, $5) RETURNING *",[e,r,o,t||null,s||null])).rows[0],m=async(e,r=50)=>(await (0,a.IO)("SELECT * FROM transactions WHERE user_id = $1 ORDER BY created_at DESC LIMIT $2",[e,r])).rows},7046:(e,r,o)=>{o.d(r,{IO:()=>n,uD:()=>s}),function(){var e=Error("Cannot find module 'pg'");throw e.code="MODULE_NOT_FOUND",e}();let a=process.env.DATABASE_URL;if(!a)throw Error("❌ DATABASE_URL n\xe3o foi definido no arquivo .env.local");let t=Object(function(){var e=Error("Cannot find module 'pg'");throw e.code="MODULE_NOT_FOUND",e}())({connectionString:a,ssl:{rejectUnauthorized:!1},max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3}),s=async()=>{try{let e=await t.connect();return console.log("✅ PostgreSQL conectado com sucesso!"),e.release(),t}catch(e){throw console.error("❌ Erro ao conectar ao PostgreSQL:",e),e}},n=async(e,r)=>{try{return await t.query(e,r)}catch(e){throw console.error("❌ Erro ao executar query:",e),e}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),a=r.X(0,[948,972,994],()=>o(1359));module.exports=a})();